# üí∏ Morus Engineering Challenge ‚Äî Payments & Statements API

Bem-vindo ao desafio t√©cnico da Morus!  
Aqui voc√™ vai implementar a l√≥gica central de **processamento de pagamentos e repasses autom√°ticos** de uma plataforma
que conecta **imobili√°rias, propriet√°rios e locat√°rios**.

O desafio mede a sua capacidade de projetar um sistema **consistente, transacional e idempotente**, capaz de lidar com
m√∫ltiplos participantes recebendo partes de um mesmo pagamento.

---
## üîç Vis√£o Geral do Projeto
Para esse projeto optei trocar para o mysql, s√≥ por motivos de familiaridade.
Eu tentei deixar o mais simples possivel o projeto, sem gerar muita complexidade mas deixando o codigo mais claro possivel tamb√©m.
Por isso para a atomicidade, eu usei apenas o @Transacional, mas em um caso real, eu poderia usar o Kafta para receber
os statements e processar os pagamentos, assim poderia criar uma deadletter queue para receber os pagamentos com falha
e processar depois ou realizar estorno.

A api deveria estar autenticada e autorizada, para isso eu teria usado o spring security e o JWT,
assim gerando um contexto do usuario que est√° realizando o pagamento e a partir disso eu pegaria
as informa√ß√µes do propertyOwner e realEstateAgency do contexto ao inves de receber da api.
Acredito que o pagamento seja s√≥ uma ponta da empresa, ent√£o creio que teriamos um Api Gateway para
fazer o roteamento dos servi√ßos. (A n√£o ser que a estrutura seja algo como um monolito, o que apesar de muitos julgarem,
acho que √© uma forte solu√ß√£o para empresas que est√£o no inicio).

Usei a aquitetura em camadas, pois acho que √© uma arquitetura mais padr√£o.

E por ultimo, no build, eu usaria o native build, para redu√ß√£o do cold start, assim poderia ser utilizado um lambda
ou at√© mesmo um container que n√£o precisasse ficar rodando 24h.

---

## üß© Contexto

A Morus atua como uma fintech do setor imobili√°rio e uma de suas funcionalidades √© receber pagamentos de aluguel
feitos por locat√°rios e repassar automaticamente os valores para os propriet√°rios e imobili√°rias.
Quando um locat√°rio paga um aluguel, esse valor precisa ser **recebido pela plataforma** e **repassado automaticamente**
para os participantes envolvidos na opera√ß√£o em uma conta digital da Morus.

- **Imobili√°ria** ‚Äì recebe uma taxa de administra√ß√£o (por exemplo, 10%)
- **Propriet√°rio do im√≥vel (Owner)** ‚Äì recebe o valor l√≠quido do aluguel
- **Morus (plataforma)** ‚Äì ret√©m uma pequena taxa de servi√ßo (por exemplo, 2%)

Sua miss√£o √© construir a API que processa esse pagamento e registra os **lan√ßamentos (Statements)** que representam o
repasse entre contas internas.

---

## üèóÔ∏è Base do Projeto

O projeto inicial j√° cont√©m:

- `Account`: representa uma conta digital (com `id`, `name`, `type`, `balance`, etc.);
    - Cada conta tem um `AccountType` representando o tipo de participante:
        - `PLATFORM_REVENUE` (conta da Morus)
        - `REAL_ESTATE_AGENCY` (conta da imobili√°ria)
        - `PROPERTY_OWNER` (conta do propriet√°rio)
- `Payment`: representa o pagamento recebido;
- `PropertyOwner`: representa o propriet√°rio do im√≥vel;
- `RealEstateAgency`: representa a imobili√°ria;
- `Statement`: representa um lan√ßamento no extrato de uma conta;

Voc√™ pode criar novas classes, DTOs, atributos, eventos ou estrat√©gias conforme achar necess√°rio, desde que mantenha a
coes√£o e clareza do projeto.
N√£o se limite ao c√≥digo inicial ‚Äî sinta-se livre para refatorar e melhorar a estrutura do projeto caso julgue
necess√°rio.

---

## üöÄ Desafio

Implementar um endpoint `/payments` que recebe um pagamento e gera os lan√ßamentos (Statements) necess√°rios para
distribuir o valor entre os participantes, garantindo:

- **Idempot√™ncia**: o mesmo pagamento n√£o pode ser processado mais de uma vez.
- **Atomicidade**: se qualquer parte do processo falhar, todo o pagamento deve ser revertido.
- **Integridade**: A soma de todos os lan√ßamentos deve ser igual ao valor do pagamento.
- **Rastreamento**: Cada lan√ßamento no extrato deve referenciar o pagamento original para auditoria.

### Regras de neg√≥cio

1. A plataforma Morus **recebe o pagamento** de R$ 3.000,00.
2. O sistema deve **distribuir automaticamente** o valor entre as contas dos participantes:
    - Exemplo: para um pagamento de R$ 3.000,00:
        - **10%** para a conta da Imobili√°ria. (Esse percentual est√° definido no cadastro da
          imobili√°ria);
        - **2%** para a conta da Morus. (Essa taxa √© fixa para todos os pagamentos);
        - **88%** para a conta do Propriet√°rio do im√≥vel;
3. Cada repasse deve ser registrado no extrato (Statement) com a identifica√ß√£o do pagamento recebido.
4. O conjunto de lan√ßamentos deve manter **integridade total** (A soma de todos os lan√ßamentos deve ser igual ao valor
   do pagamento).
5. O mesmo pagamento n√£o pode ser processados duas vezes (**idempot√™ncia obrigat√≥ria**).
6. A opera√ß√£o deve ser **at√¥mica** ‚Äî se um repasse falhar, todo o pagamento √© revertido.

---

### üí∞ Exemplo de comportamento esperado

**Requisi√ß√£o**

```bash
POST /payments
{
  "externalReference": "PAY-202501",
  "amount": 3000.00,
  "realEstateAgencyId": "IMB-001",
  "propertyOwnerId": "P-001",
  "description": "Pagamento de aluguel de janeiro"
}
```

**Resposta**

```bash
HTTP 201 Created
{
  "externalReference": "PAY-202501",
  "amount": 3000.00,
  "realEstateAgencyId": "IMB-001",
  "propertyOwnerId": "P-001",
  "description": "Pagamento de aluguel de janeiro",
  "createdAt": "2025-01-15T10:32:11"
}
```

**Representa√ß√£o simb√≥lica dos lan√ßamentos gerados**

| payment    | account          |  amount | description                          | createdAt           |
|------------|------------------|--------:|--------------------------------------|---------------------|
| PAY-202501 | IMB-001          |  300.00 | Recebimento de taxa de administra√ß√£o | 2025-01-15T10:32:11 |
| PAY-202501 | P-001            | 2640.00 | Repasse de aluguel                   | 2025-01-15T10:32:11 |
| PAY-202501 | PLATFORM_REVENUE |   60.00 | Receita da plataforma                | 2025-01-15T10:32:11 |

Ao final do processo, o extrato de cada conta deve refletir os lan√ßamentos e os seus respectivos saldos atualizados.

---

## ‚öôÔ∏è Requisitos obrigat√≥rios

1. Implementar o endpoint `/payments` com a l√≥gica de distribui√ß√£o e gera√ß√£o dos lan√ßamentos.
2. Criar `Statement` para todos os repasses e taxas.
3. Garantir **idempot√™ncia** (mesmo pagamento n√£o gera lan√ßamentos duplicados).
4. Garantir **atomicidade** (rollback total em caso de falha).
5. Implementar testes automatizados com no m√≠nimo 85% de cobertura (casos de sucesso e falha).
6. Explicar decis√µes t√©cnicas no `README.md`.

---

## üß† Requisitos b√¥nus (n√£o obrigat√≥rios, por√©m, se implementados, ser√£o considerados na avalia√ß√£o)

- **Endpoint `/statements/{accountId}`:** retornar o extrato completo de uma conta.
- **Cria√ß√£o de um endpoint para simular saques:** permitir que uma conta fa√ßa o cashout de um valor, gerando um
  lan√ßamento negativo e refletindo no saldo da conta.
- **Valida√ß√µes adicionais:** verificar se as contas existem, se o valor √© positivo, se o propriet√°rio est√° vinculado √†
  imobili√°ria, etc.
- **Tratamento de erros:** respostas claras e apropriadas para falhas.
- **Testes de integra√ß√£o:** al√©m dos testes unit√°rios.
- **Pagina√ß√£o e filtros** nos extratos.
- **Documenta√ß√£o da API:** usando Swagger/OpenAPI.
- **Autentica√ß√£o e autoriza√ß√£o:** proteger os endpoints.
- **M√©tricas:** expor m√©tricas de pagamentos processados, falhas, etc
- **Processamento ass√≠ncronos:** Processar pagamentos de forma ass√≠ncrona.

---

## üß™ Testes

Crie testes cobrindo:

- Pagamento processado com sucesso;
- Tentativa de duplica√ß√£o (idempot√™ncia);
- Falha durante o processo (rollback total);

---

## üß∞ Tecnologias sugeridas

- Java 21+
- Spring Boot 3+
- Maven
- H2 Database (ou outro relacional)
- JUnit / Mockito
- Docker

Voc√™ pode usar Lombok, Flyway, Docker Compose ou qualquer ferramenta √∫til ‚Äî apenas documente as suas escolhas.

---

## ‚ñ∂Ô∏è Como executar

```bash
# Clonar o reposit√≥rio
git clone https://github.com/morusbank/engineering-challenge.git
cd engineering-challenge

# Executar a aplica√ß√£o
mvn spring-boot:run
```

---

## üì¶ Entrega

1. Crie um zip da pasta do projeto (sem a pasta `target` e arquivos desnecess√°rios) e envie para o e-mail
   [contato@morusbank.com.br](mailto:contato@morusbank.com.br) informando no assunto "Desafio T√©cnico -
   Engenharia - [Seu Nome]".
2. Inclua no seu `README.md`:
    - Vis√£o geral do projeto com uma breve descri√ß√£o da sua solu√ß√£o e principais decis√µes;
    - Os passos necess√°rios para rodar a aplica√ß√£o e validar os cen√°rios solicitados no desafio;
    - Quaisquer melhorias que voc√™ faria se tivesse mais tempo.

---

## üí¨ Dicas finais

* O objetivo n√£o √© complexidade ‚Äî √© **clareza e robustez**.
* Queremos ver como voc√™ estrutura um fluxo de neg√≥cio cr√≠tico com simplicidade e coes√£o.
* Um c√≥digo limpo e transacional vale mais do que qualquer abstra√ß√£o sofisticada.
* O uso de padr√µes de projeto (Design Patterns) √© bem-vindo, mas **n√£o exagere**.
* Seja criativo e mostre as suas habilidades. Caso n√£o consiga completar tudo, n√£o tem problema. Queremos ver o seu
  racioc√≠nio e qualidade do c√≥digo, n√£o esperamos uma solu√ß√£o perfeita.
* O uso de IA √© permitido e incentivado, por√©m, lembre-se de que o c√≥digo √© seu e voc√™ deve entender claramente o que
  est√° implementado.

Voc√™ tem **7 dias corridos** para completar o desafio a partir do recebimento deste e-mail, mas se terminar antes,
sinta-se √† vontade para enviar.

---

> Caso opte por implementar o desafio utilizando outra linguagem, n√£o tem problema, mas **explique as suas escolhas**
> no README do seu projeto e coloque as instru√ß√µes de como executar a aplica√ß√£o.

**Boa sorte!**  
A equipe da Morus est√° animada para ver como voc√™ transforma l√≥gica de repasse em um sistema confi√°vel e elegante üöÄ

>
> Any fool can write code that a computer can understand. Good programmers write code that humans can understand.
> ‚Äì Martin Fowler
>
